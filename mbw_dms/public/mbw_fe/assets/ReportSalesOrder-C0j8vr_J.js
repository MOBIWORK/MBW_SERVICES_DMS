import{L as a,aX as ve,a3 as c,P as e,a8 as Fe,U as _,V as S,Q as P,R as m,aV as ke,aT as u,a9 as we,W as x,ab as Ce,bz as o,Y as v,aW as $,ad as Te}from"./index-f6BFzVtx.js";import{D as Ie}from"./index-8NKHhtPT.js";import{C as De}from"./index-CuiDXtH7.js";import{u as h}from"./useDebount-0KTpV7bi.js";import{t as Ee,a as Re}from"./index-Nqj_Vmem.js";import{a as Ye,b as Ve}from"./index.esm-SqMuMJ9H.js";import{u as Ke}from"./index-mEJXdmqA.js";import{D as H}from"./index-cIGrzALf.js";import{V as Oe}from"./VerticalAlignBottomOutlined-rKGQJjR4.js";const p=v().startOf("month"),y=v().endOf("month");let ze=Date.parse(p.$d)/1e3,We=Date.parse(y.$d)/1e3;const Le=[{title:e.jsx("div",{className:"relative",children:e.jsx("span",{className:"absolute -top-[11px] -left-8",children:"STT"})}),dataIndex:"stt",key:"stt",render:(l,n,d)=>d+1},{title:"Đơn đặt",dataIndex:"name",key:"name",render:(l,n)=>e.jsx("div",{children:e.jsx("a",{className:"text-[#212B36]",href:`/app/sales-order/${n.name}`,target:"_blank",children:n.name})})},{title:"Khách hàng",dataIndex:"customer",key:"customer",render:(l,n)=>e.jsx("div",{children:n.customer})},{title:"Khu vực",dataIndex:"territory",key:"territory",render:(l,n)=>e.jsx("div",{children:n.territory})},{title:"Kho",dataIndex:"set_warehouse",key:"set_warehouse"},{title:"Ngày tạo",dataIndex:"transaction_date",key:"transaction_date",render:l=>l?e.jsx("p",{children:v(l*1e3).format("DD/MM/YYYY")}):e.jsx(e.Fragment,{})},{title:"Nhân viên",dataIndex:"employee",key:"employee",render:(l,n)=>e.jsx("div",{className:"!w-[150px]",children:n.employee})},{title:e.jsx("div",{className:"text-right",children:"Thành tiền (VNĐ)"}),dataIndex:"total",key:"total",width:160,render:(l,n)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(n.total)})},{title:e.jsx("div",{className:"text-right",children:"Tiền VAT (VNĐ)"}),dataIndex:"tax_amount",key:"tax_amount",width:160,render:(l,n)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(n.tax_amount)})},{title:e.jsx("div",{className:"text-right",children:"Chiết khấu (VNĐ)"}),dataIndex:"discount_amount",key:"discount_amount",width:160,render:(l,n)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(n.discount_amount)})},{title:e.jsx("div",{className:"text-right",children:"Tổng tiền (VNĐ)"}),dataIndex:"grand_total",key:"grand_total",width:160,render:(l,n)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(n.grand_total)})}];function Me(){const[l,n]=a.useState([]),[d,X]=a.useState(0),g=20,[f,U]=a.useState(1),[G,Q]=a.useState([]),[F,k]=a.useState(""),[Z,qe]=a.useState(""),[w,C]=a.useState(""),[J,ee]=a.useState([]),[te,Be]=a.useState(""),[T,I]=a.useState(""),[ae,se]=a.useState([]),[re,Ae]=a.useState(""),[D,E]=a.useState(ze),[R,Y]=a.useState(We),[V,K]=a.useState(""),[j]=ve(),[ne,le]=a.useState([]),[oe,Pe]=a.useState(""),[O,z]=a.useState(""),[ie,me]=a.useState([]),[ce,de]=a.useState([]),[W,ue]=a.useState();let L=h(Z,500),M=h(te,500),q=h(re,500),B=h(oe,500);const[he,xe]=a.useState("");let A=h(he);const b=a.useRef(null),N=Ke(),[pe,ye]=a.useState(0),[ge,fe]=a.useState(N?.h*.52);a.useEffect(()=>{fe(N.h*.52)},[N]),a.useEffect(()=>{const t=b.current;if(t){const r=new ResizeObserver(s=>{for(let i of s)ye(i.contentRect.height)});return r.observe(t),()=>r.disconnect()}},[b]);const je=t=>{const r=[{title:"STT",dataIndex:"stt",key:"stt",render:(s,i,Se)=>Se+1},{title:"Mã sản phẩm",dataIndex:"item_code",key:"item_code"},{title:"Tên sản phẩm",dataIndex:"item_name",key:"item_name"},{title:"Nhóm sản phẩm",dataIndex:"item_group",key:"item_group"},{title:"Nhãn hàng",dataIndex:"brand",key:"brand"},{title:e.jsx("div",{className:"text-right",children:"Đơn giá"}),dataIndex:"rate",key:"rate",render:(s,i)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(i.rate)})},{title:e.jsx("div",{className:"text-right",children:"Số lượng"}),dataIndex:"qty",key:"qty",render:(s,i)=>e.jsx("div",{className:"!text-right",children:i.qty})},{title:e.jsx("div",{className:"text-right",children:"Chiết khấu (%)"}),dataIndex:"discount_percentage",key:"discount_percentage",render:(s,i)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(i.discount_percentage)})},{title:e.jsx("div",{className:"text-right",children:"Tiền chiết khấu"}),dataIndex:"discount_amount",key:"discount_amount",render:(s,i)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(i.discount_amount)})},{title:e.jsx("div",{className:"text-right",children:"Tổng tiền (VNĐ)"}),dataIndex:"amount",key:"amount",render:(s,i)=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(i.amount)})}];return e.jsx(o,{bordered:!0,columns:r,dataSource:t.items.map(s=>({...s,key:s.item_code})),pagination:!1})};a.useEffect(()=>{(async()=>{let t=await c.get("/api/method/frappe.desk.search.search_link",{params:{txt:L,doctype:"Company",ignore_user_permissions:0,query:""}}),{message:r}=t;Q(r.map(s=>({value:s.value,label:s.value})))})()},[L]),a.useEffect(()=>{(async()=>{let t=await c.get("/api/method/frappe.desk.search.search_link",{params:{txt:q,doctype:"Customer",ignore_user_permissions:0,query:""}}),{message:r}=t;se(r.map(s=>({value:s.value,label:s.value})))})()},[q]),a.useEffect(()=>{(async()=>{let t=await c.get("/api/method/frappe.desk.search.search_link",{params:{txt:B,doctype:"Warehouse",ignore_user_permissions:0,query:""}}),{message:r}=t;le(r.map(s=>({value:s.value,label:s.value})))})()},[B]),a.useEffect(()=>{(async()=>{let t=await c.get("/api/method/frappe.desk.search.search_link",{params:{txt:M,doctype:"Territory",ignore_user_permissions:0,query:""}}),{message:r}=t;ee(r.map(s=>({value:s.value,label:s.value})))})()},[M]),a.useEffect(()=>{(async()=>{let t=await c.get("/api/method/mbw_dms.api.router.get_team_sale");de(Ee({data:t.result.map(r=>({title:r.name,value:r.name,...r})),keyValue:"value",parentField:"parent_sales_person"}))})()},[]),a.useEffect(()=>{(async()=>{let t=await c.get("/api/method/mbw_dms.api.router.get_sale_person",{params:{team_sale:W,key_search:A}}),{message:r}=t;me(r.map(s=>({value:s.employee_code,label:s.employee_name||s.employee_code})))})()},[W,A]),a.useEffect(()=>{(async()=>{const t=await c.get("/api/method/mbw_dms.api.report.so_report.so_report",{params:{page_size:g,page_number:f,company:F,territory:w,customer:T,from_date:D,to_date:R,warehouse:V,employee:O}});let{result:r}=t;n(r),X(r?.totals)})()},[f,F,w,T,D,R,V,O]);const be=t=>{if(t==null)E("");else if(y&&t&&t.isAfter(y,"day"))$.error("Từ ngày phải nhỏ hơn hoặc bằng Đến ngày");else{let r=Date.parse(t.$d)/1e3;E(r)}},Ne=t=>{if(t==null)Y("");else if(p&&t&&t.isBefore(p,"day"))$.error("Đến ngày phải lớn hơn hoặc bằng Từ ngày");else{let r=Date.parse(t.$d)/1e3;Y(r)}},_e=t=>{t.company?k(t.company):k(""),t.customer?I(t.customer):I(""),t.territory?C(t.territory):C(""),t.warehouse?K(t.warehouse):K("")};return e.jsx(e.Fragment,{children:e.jsx(De,{header:e.jsx(Fe,{title:"Báo cáo tổng hợp đặt hàng",buttons:[{label:"Xuất dữ liệu",type:"primary",icon:e.jsx(Oe,{className:"text-xl"}),size:"20px",className:"flex items-center",action:()=>{Re("/app/data-export/Data%20Export")}}]}),children:e.jsxs("div",{className:"bg-white rounded-2xl pt-4 pb-7 border-[#DFE3E8] border-[0.2px] border-solid",children:[e.jsxs(_,{gutter:[16,16],className:"justify-between items-end w-full",children:[e.jsx(S,{children:e.jsx(_,{gutter:[8,8],children:e.jsx(S,{className:"mx-4 w-full",span:24,children:e.jsxs(P,{layout:"vertical",className:"flex flex-wrap justify-start items-center ",children:[e.jsx(m,{label:"Từ ngày",className:"w-[200px] border-none mr-2",children:e.jsx(H,{format:"DD-MM-YYYY",className:"!bg-[#F4F6F8] !h-7 rounded-lg mt-[-2px]",placeholder:"Từ ngày",onChange:be,defaultValue:p})}),e.jsx(m,{label:"Đến ngày",className:"w-[200px] border-none mr-2",children:e.jsx(H,{format:"DD-MM-YYYY",className:"!bg-[#F4F6F8] !h-7 rounded-lg mt-[-2px]",onChange:Ne,placeholder:"Đến ngày",defaultValue:y})}),e.jsx(m,{label:"Nhóm bán hàng",className:"border-none mr-2 w-[200px]",children:e.jsx(ke,{placeholder:"Tất cả nhóm bán hàng",allowClear:!0,treeData:ce,onChange:t=>{ue(t)},dropdownStyle:{maxHeight:400,overflow:"auto",minWidth:400}})}),e.jsx(m,{label:"Nhân viên",className:"border-none mr-2 w-[200px]",name:"employee",children:e.jsx(u,{filterOption:!1,notFoundContent:null,allowClear:!0,placeholder:"Tất cả nhân viên",onSearch:t=>{xe(t)},options:ie,onSelect:t=>{z(t)},onClear:()=>{z("")}})})]})})})}),e.jsx(S,{className:"!ml-4",children:e.jsx("div",{className:"flex flex-wrap items-center",children:e.jsxs("div",{className:"flex justify-center items-center mr-4",children:[e.jsx(we,{className:"!h-9",placement:"bottomRight",trigger:["click"],dropdownRender:()=>e.jsxs(Ie,{title:"Bộ lọc",children:[e.jsx("div",{className:"",children:e.jsxs(P,{layout:"vertical",form:j,onFinish:_e,children:[e.jsx(m,{name:"company",label:"Công ty",className:"w-[468px] border-none",children:e.jsx(u,{allowClear:!0,className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:G,placeholder:"Tất cả công ty"})}),e.jsx(m,{name:"customer",label:"Khách hàng",className:"w-[468px] border-none pt-2",children:e.jsx(u,{allowClear:!0,className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:ae,placeholder:"Tất cả khách hàng"})}),e.jsx(m,{name:"territory",label:"Khu vực",className:"w-[468px] border-none pt-2",children:e.jsx(u,{allowClear:!0,className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:J,placeholder:"Tất cẩ khu vực"})}),e.jsx(m,{name:"warehouse",label:"Kho",className:"w-[468px] border-none pt-2",children:e.jsx(u,{allowClear:!0,className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:ne,placeholder:"Tất cả kho"})})]})}),e.jsxs(_,{className:"justify-between pt-6 pb-4",children:[e.jsx("div",{}),e.jsxs("div",{children:[e.jsx(x,{className:"mr-3",onClick:t=>{t.preventDefault(),j.resetFields()},children:"Đặt lại"}),e.jsx(x,{type:"primary",onClick:()=>{j.submit()},children:"Áp dụng"})]})]})]}),children:e.jsx(x,{onClick:t=>t.preventDefault(),className:"flex items-center text-nowrap !text-[13px] !leading-[21px] !font-normal  border-r-[0.1px] rounded-r-none h-9",icon:e.jsx(Ye,{style:{fontSize:"20px"}}),children:"Bộ lọc"})}),e.jsx(x,{className:"border-l-[0.1px] rounded-l-none !h-9",children:e.jsx(Ve,{style:{fontSize:"20px"}})})]})})})]}),e.jsx("div",{ref:b,className:"pt-5",children:e.jsx(Ce,{dataSource:l?.data?.map(t=>({...t,key:t.name})),expandable:{expandedRowRender:je,defaultExpandedRowKeys:["0"]},bordered:!0,$border:!0,columns:Le,scroll:{x:!0,y:pe<380?void 0:ge},pagination:d&&d>g?{pageSize:g,showSizeChanger:!1,total:d,current:f,onChange(t){U(t)}}:!1,summary:()=>(console.log("sale",l),e.jsxs(o.Summary.Row,{children:[e.jsx(o.Summary.Cell,{index:0,className:"!border-r-0"}),e.jsx(o.Summary.Cell,{index:1}),e.jsx(o.Summary.Cell,{index:2,children:"Tổng"}),e.jsx(o.Summary.Cell,{index:3}),e.jsx(o.Summary.Cell,{index:4}),e.jsx(o.Summary.Cell,{index:5}),e.jsx(o.Summary.Cell,{index:6}),e.jsx(o.Summary.Cell,{index:7}),e.jsx(o.Summary.Cell,{index:8,children:e.jsx("div",{className:"text-right",children:Intl.NumberFormat().format(l?.sum?.sum_total)})}),e.jsx(o.Summary.Cell,{index:9,children:e.jsx("div",{className:"text-right",children:Intl.NumberFormat().format(l?.sum?.sum_vat)})}),e.jsx(o.Summary.Cell,{index:10,children:e.jsx("div",{className:"text-right",children:Intl.NumberFormat().format(l?.sum?.sum_discount_amount)})}),e.jsx(o.Summary.Cell,{index:11,children:e.jsx("div",{className:"text-right",children:Intl.NumberFormat().format(l?.sum?.sum_grand_total)})})]}))})})]})})})}function tt(){return e.jsxs(e.Fragment,{children:[e.jsx(Te,{children:e.jsx("title",{children:" ReportSalesOrder"})}),e.jsx(Me,{})]})}export{tt as default};
