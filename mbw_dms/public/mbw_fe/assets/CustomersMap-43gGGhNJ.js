import{W as c,a0 as h,aS as d,L as n,bG as S}from"./index-1V10OnT5.js";import{H as A}from"./header-page-GoctC0yb.js";function M(){const[u,_]=c.useState(""),[l,y]=c.useState([]),[m,f]=c.useState([]),e=c.useRef(null),[p,x]=c.useState(!1),[g,v]=c.useState(!0),C=()=>{x(!p)},b=()=>{v(!g),k()},k=()=>{const o=g?"none":"visible";e.current.getStyle().layers.forEach(t=>{t.id.includes("customer")&&e.current.setLayoutProperty(t.id,"visibility",o)})};c.useEffect(()=>{N()},[]),c.useEffect(()=>{u!=null&&u!=""&&T()},[u]),c.useEffect(()=>{B()},[m]),c.useEffect(()=>{w()},[l]);const N=async()=>{let o=await h.get("/api/method/mbw_dms.api.vgm.map_customer.get_config_api");_(o.result)},H=async()=>{let o=await h.get("/api/method/mbw_dms.api.vgm.map_customer.get_config_map?type_industry=fertilizer_store");y(o.result)},L=async()=>{let o=JSON.parse('{"message":"Thành công","result":[{"name":"A Lâm","customer_name":"A Lâm","customer_code":"BH0123111115","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"A Lâm","customer_primary_address":"395 Xuân Đỉnh, phường Xuân Đỉnh, Từ Liêm, Hà Nội, Việt Nam-Billing","customer_location_primary":"{\\"lat\\":20.7894317,\\"long\\":105.70448}"},{"name":"A Phương","customer_name":"A Phương","customer_code":"BH0120235252","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"A Phương-A Phương","customer_primary_address":"538 Xuân Đỉnh, phường Xuân Đỉnh, Tây Hồ, Hà Nội, Việt Nam-Billing","customer_location_primary":"{\\"lat\\":21.0763504,\\"long\\":105.7869008}"},{"name":"A thuật","customer_name":"A thuật","customer_code":"HN11402","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":null,"customer_primary_address":"Đình Vĩnh Xương Trung, Mỹ Thành, Mỹ Đức, Hà Nội-Billing","customer_location_primary":"{\\"lat\\":20.6903959,\\"long\\":105.7689993}"},{"name":"A Toản","customer_name":"A Toản","customer_code":"BH0050608072022","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"A Toản","customer_primary_address":"408 Trần Cung, Cổ Nhuế 1, Cầu Giấy, Hà Nội, Việt Nam-Billing","customer_location_primary":"{\\"lat\\":21.0555955,\\"long\\":105.7855697}"},{"name":"Anh  Hạnh","customer_name":"Anh  Hạnh","customer_code":"BH0057110022023","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"Anh  Hạnh","customer_primary_address":"440 Cổ Nhuế, Cổ Nhuế 2, Từ Liêm, Hà Nội, Vietnam-Billing","customer_location_primary":"{\\"lat\\":21.069679,\\"long\\":105.7781418}"},{"name":"Xuyến  ngũ","customer_name":"Xuyến  ngũ","customer_code":"HN9251","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":null,"customer_primary_address":"Huyện Ứng Hòa, Hà Nội, VNM-Billing-2","customer_location_primary":"{\\"lat\\":20.7192067,\\"long\\":105.8028217}"},{"name":"Yến  Hiệp","customer_name":"Yến  Hiệp","customer_code":"HN8847","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":null,"customer_primary_address":"Tảo Khê  tảo  Dương  văn  ứng  hòa hà Nội-Billing","customer_location_primary":"{\\"lat\\":20.7082736,\\"long\\":105.7821972}"}]}');console.log(o),f(o.result)},T=()=>{e.current=new d.Map({container:"map",center:[108.485,16.449],zoom:5.43}),new ekmapplf.VectorBaseMap("OSM:Bright",u).addTo(e.current);var o=new ekmapplf.control.BaseMap({id:"basemap_control",baseLayers:[{id:"OSM:Bright",title:"Bản đồ nền Sáng",thumbnail:"https://docs.ekgis.vn/assets/map-sang.png",width:"50px",height:"50px"},{id:"OSM:Standard",title:"Bản đồ nền Tiêu chuẩn",thumbnail:"https://docs.ekgis.vn/assets/map-chuan.png",width:"50px",height:"50px"},{id:"OSM:Night",title:"Bản đồ nền Đêm",thumbnail:"https://docs.ekgis.vn/assets/dem-map.png",width:"50px",height:"50px"}]});e.current.addControl(o,"bottom-left"),o.on("changeBaseLayer",async function(i){await new ekmapplf.VectorBaseMap(i.layer,u).addTo(e.current)}),e.current.addControl(new d.NavigationControl({visualizePitch:!0}),"bottom-right");var t=!1;e.current.getPitch()>0?t=!0:t=!1;var s="maplibregl-terrain2d-control",r="Hiển thị 2D";t||(s="maplibregl-terrain3d-control",r="Bản đồ 3D");let a=new ekmapplf.control.Button({className:"btn-ctl-group "+s,icon:"none",tooltip:r});a.on("click",i=>{t=!t,t?(i._div.className=i._div.className.replaceAll("maplibregl-terrain3d-control","maplibregl-terrain2d-control"),i._div.title="Hiển thị 2D"):(i._div.className=i._div.className.replaceAll("maplibregl-terrain2d-control","maplibregl-terrain3d-control"),i._div.title="Hiển thị 3D"),t?(e.current.easeTo({pitch:60}),e.current.setLayoutProperty("building-3d","visibility","visible")):(e.current.easeTo({pitch:0}),e.current.setLayoutProperty("building-3d","visibility","none"))}),e.current.addControl(a,"bottom-right"),e.current.addControl(new d.FullscreenControl,"top-right"),e.current.on("load",async()=>{await H(),L()})},w=()=>{for(let o=0;o<l.length;o++)if(l[o].visible){let t=l[o].sources,s=l[o].layers;for(let r in t)e.current.getSource(r)||e.current.addSource(r,t[r]);for(let r=0;r<s.length;r++)e.current.getLayer(s[r].id)||e.current.addLayer(s[r])}},B=async()=>{let o={type:"FeatureCollection",features:[]};for(let t=0;t<m.length;t++){let s=JSON.parse(m[t].customer_location_primary),r={type:"Feature",geometry:{type:"Point",coordinates:[s.long,s.lat]},properties:m[t]};o.features.push(r)}if(e.current!=null&&e.current.isStyleLoaded())if(e.current.getSource("customer_clus"))e.current.getSource("customer_clus").setData(o);else{if(!e.current.getImage("marker-customer")){const t=await e.current.loadImage("/public/check-icon.png");e.current.addImage("marker-customer",t.data)}e.current.addSource("customer_clus",{type:"geojson",data:o,cluster:!0,clusterRadius:12}),e.current.addLayer({id:"customer_clus-cluster",type:"circle",source:"customer_clus",maxzoom:16,filter:["has","point_count"],paint:{"circle-color":["step",["get","point_count"],"#90D667",10,"#EFCD41",50,"#FF0012"],"circle-radius":12,"circle-stroke-color":["step",["get","point_count"],"#90D667",10,"#EFCD41",50,"#FF0012"],"circle-stroke-opacity":.7,"circle-stroke-width":5}}),e.current.addLayer({id:"customer_clus-cluster-count",type:"symbol",source:"customer_clus",filter:["has","point_count"],layout:{"text-field":"{point_count}","text-size":12}}),e.current.on("mouseenter","customer_clus-uncluster",()=>{e.current.getCanvas().style.cursor="pointer"}),e.current.on("mouseleave","customer_clus-uncluster",()=>{e.current.getCanvas().style.cursor=""}),e.current.on("click","customer_clus-cluster",async t=>{const s=e.current.queryRenderedFeatures(t.point,{layers:["customer_clus-cluster"]}),r=s[0].properties.cluster_id,a=await e.current.getSource("customer_clus-cluster").getClusterExpansionZoom(r);e.current.easeTo({center:s[0].geometry.coordinates,zoom:a+.01})}),e.current.addLayer({id:"customer_clus-uncluster",type:"symbol",source:"customer_clus",filter:["!",["has","point_count"]],layout:{"icon-image":"marker-customer","icon-allow-overlap":!0,"icon-size":{stops:[[15,.7],[18,1]]}}}),e.current.addLayer({id:"customer_clus-title",type:"symbol",source:"customer_clus",filter:["!",["has","point_count"]],layout:{"text-field":["get","customer_name"],"text-font":["Roboto Medium"],"text-size":{stops:[[12,10],[13,11],[14,11],[15,11.5],[16,12.5],[20,16]]},"text-anchor":"top","text-max-width":9,"text-offset":[0,1.5],"text-padding":5},paint:{"text-color":"#ff5532","text-halo-color":"#ffffff","text-halo-width":1,"text-halo-blur":.5}}),e.current.on("click","customer_clus-uncluster",function(t){var s=t.features[0].geometry.coordinates.slice(),r=t.features[0].properties,a=`
                <div class="customer-popup-info">
                    <b>${r.customer_name}</b>
                </div>
            `;r.customer_primary_address!=null&&r.customer_primary_address!=""&&(a+=`
                <div class="customer-popup-info">
                    <span class="customer-popup-icon customer-icon-marker customer-icon-default-color"></span>
                    <span>${r.customer_primary_address}</span>
                </div>`),r.customer_primary_contact!=null&&r.customer_primary_contact!=""&&(a+=`
                <div class="customer-popup-info">
                    <span class="customer-popup-icon customer-icon-phone customer-icon-default-color"></span>
                    <span>${r.customer_primary_contact}</span>
                </div>`),new d.Popup().setLngLat(s).setHTML(a).addTo(e.current)})}};return n.jsxs(n.Fragment,{children:[n.jsx(A,{title:"Bản đồ khách hàng"}),n.jsx("div",{id:"map",style:{width:"100%",height:"80vh",borderRadius:"20px"},children:n.jsxs("div",{id:"ekmapplf_tracking_legend",className:"ekmapplf_tracking-map-legend",children:[n.jsxs("div",{className:"ekmapplf_tracking-legend-title",onClick:C,children:[n.jsx("span",{className:`icon ${p?"ekmapplf_tracking-icon-square-minus":"ekmapplf_tracking-icon-square-plus"}`,style:{filter:"invert(100%) sepia(100%) saturate(0%) hue-rotate(187deg) brightness(105%) contrast(103%)"}}),n.jsx("span",{children:"Chú giải bản đồ"})]}),n.jsx("div",{className:`ekmapplf_tracking-legend-body ${p?"open":""}`,style:{maxHeight:p?"none":"0"},children:n.jsx("ul",{children:n.jsxs("li",{children:[n.jsx(S,{checked:g,onChange:b}),n.jsx("span",{className:"ekmapplf_tracking-legend-icon",style:{backgroundImage:"url('/checking.png')"}}),"Vị trí khách hàng"]})})})]})})]})}function P(){return n.jsx(M,{})}export{P as default};
