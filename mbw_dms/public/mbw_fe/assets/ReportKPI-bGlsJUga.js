import{Y as n,V as _,a1 as N,L as e,ab as F,a6 as se,a7 as le,bD as re,R as oe,P as I,a2 as K,aa as ie,bE as i,ad as de}from"./index-vZfgxf7p.js";import{u as he,C as me,S as ce}from"./index-ZouZ_lpj.js";import{u as ue}from"./useDebount-EI1KB0SQ.js";import{M as Y}from"./ModalCheckin-Xlu83Imr.js";import{D as xe}from"./index-dL95hn5Q.js";import{V as _e}from"./VerticalAlignBottomOutlined-EJh0_oL6.js";const pe=[{label:"Tháng 1",value:"1"},{label:"Tháng 2",value:"2"},{label:"Tháng 3",value:"3"},{label:"Tháng 4",value:"4"},{label:"Tháng 5",value:"5"},{label:"Tháng 6",value:"6"},{label:"Tháng 7",value:"7"},{label:"Tháng 8",value:"8"},{label:"Tháng 9",value:"9"},{label:"Tháng 10",value:"10"},{label:"Tháng 11",value:"11"},{label:"Tháng 12",value:"12"}],ge=[{title:"STT",dataIndex:"stt",key:"stt",width:60,render:(s,h,r)=>r+1},{title:"Mã khách hàng",dataIndex:"kh_ma",key:"kh_ma"},{title:"Khách hàng",dataIndex:"kh_ten",key:"kh_ten"},{title:"Địa chỉ",dataIndex:"kh_diachi",key:"kh_diachi",render:s=>e.jsx("div",{className:"truncate hover:whitespace-normal",children:s})},{title:"Ngày viếng thăm",dataIndex:"checkin_giovao",key:"checkin_giovao",render:s=>e.jsx(e.Fragment,{children:e.jsx("div",{children:_(s).format("DD/MM/YYYY")})})},{title:"Thời gian checkin",dataIndex:"checkin_giovao",key:"checkin_giovao",render:s=>e.jsx(e.Fragment,{children:e.jsx("div",{children:_(s).format("HH:mm")})})},{title:"Khoảng cách",dataIndex:"checkin_khoangcach",key:"checkin_khoangcach",render:s=>e.jsx("div",{children:parseFloat((s/60).toFixed(2))})}];function fe({employee:s,month:h,year:r}){const[m,c]=n.useState(1),u=20,[x,v]=n.useState(0),[j,y]=n.useState([]),S=_(`${r}-${h}-01`).startOf("month"),f=_(`${r}-${h}-01`).add(1,"month").startOf("month").subtract(1,"second"),o=S.unix(),p=f.unix();return n.useEffect(()=>()=>{c(1)},[s]),n.useEffect(()=>{(async()=>{const l=await N.get("/api/method/mbw_dms.api.report.kpi.kpi_visit_detail",{params:{from_date:o,to_date:p,employee:s,page_size:u,page_number:m}});let{result:g}=l;y(g),v(g?.totals)})()},[o,p,s,m]),e.jsx(e.Fragment,{children:e.jsx(F,{bordered:!0,$border:!0,dataSource:j?.data?.map(l=>({key:l.name,...l})),pagination:x&&x>u?{pageSize:u,showSizeChanger:!1,total:x,current:m,onChange(l){c(l)}}:!1,scroll:{y:300},columns:ge})})}const je=[{title:"STT",dataIndex:"stt",key:"stt",width:60,render:(s,h,r)=>r+1},{title:"Mã đơn hàng",dataIndex:"name",key:"name"},{title:"Khách hàng",dataIndex:"customer",key:"customer"},{title:"Ngày đặt",dataIndex:"collec_date",key:"collec_date",render:s=>e.jsx(e.Fragment,{children:e.jsx("div",{children:_.unix(s).format("DD/MM/YYYY")})})},{title:"Tông tiền",dataIndex:"grand_total",key:"grand_total",render:s=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(s)})}];function ye({employee:s,month:h,year:r}){const[m,c]=n.useState(1),u=20,[x,v]=n.useState(0),[j,y]=n.useState([]),S=_(`${r}-${h}-01`).startOf("month"),f=_(`${r}-${h}-01`).add(1,"month").startOf("month").subtract(1,"second"),o=S.unix(),p=f.unix();return n.useEffect(()=>()=>{c(1)},[s]),n.useEffect(()=>{(async()=>{const l=await N.get("/api/method/mbw_dms.api.report.kpi.kpi_so_amount_detail",{params:{from_date:o,to_date:p,employee:s,page_size:u,page_number:m}});let{result:g}=l;y(g),v(g?.totals)})()},[o,p,s,m]),e.jsx(e.Fragment,{children:e.jsx(F,{bordered:!0,$border:!0,dataSource:j?.data?.map(l=>({key:l.name,...l})),pagination:x&&x>u?{pageSize:u,showSizeChanger:!1,total:x,current:m,onChange(l){c(l)}}:!1,scroll:{y:300},columns:je})})}const Se=[{title:"STT",dataIndex:"stt",key:"stt",width:60,render:(s,h,r)=>r+1},{title:"Mã đơn hàng",dataIndex:"name",key:"name"},{title:"Khách hàng",dataIndex:"customer",key:"customer"},{title:"Ngày đặt",dataIndex:"collec_date",key:"collec_date",render:s=>e.jsx(e.Fragment,{children:e.jsx("div",{children:_.unix(s).format("DD/MM/YYYY")})})},{title:"Tông tiền",dataIndex:"grand_total",key:"grand_total",render:s=>e.jsx("div",{className:"!text-right",children:Intl.NumberFormat().format(s)})}];function be({employee:s,month:h,year:r}){const[m,c]=n.useState(1),u=20,[x,v]=n.useState(0),[j,y]=n.useState([]),S=_(`${r}-${h}-01`).startOf("month"),f=_(`${r}-${h}-01`).add(1,"month").startOf("month").subtract(1,"second"),o=S.unix(),p=f.unix();return n.useEffect(()=>()=>{c(1)},[s]),n.useEffect(()=>{(async()=>{const l=await N.get("/api/method/mbw_dms.api.report.kpi.kpi_si_amount_detail",{params:{from_date:o,to_date:p,employee:s,page_size:u,page_number:m}});let{result:g}=l;y(g),v(g?.totals)})()},[o,p,s,m]),e.jsx(e.Fragment,{children:e.jsx(F,{bordered:!0,$border:!0,dataSource:j?.data?.map(l=>({key:l.name,...l})),pagination:x&&x>u?{pageSize:u,showSizeChanger:!1,total:x,current:m,onChange(l){c(l)}}:!1,scroll:{y:300},columns:Se})})}const{Column:d,ColumnGroup:R}=F,ve=_().month()+1,A=ve.toString(),ke=_().format("YYYY");function we(){const[s,h]=n.useState([]),[r,m]=n.useState([]),[c,u]=n.useState(),[x,v]=n.useState(""),[j,y]=n.useState();let S=ue(x);const[f,o]=n.useState(1),p=20,[l,g]=n.useState([]),[w,V]=n.useState(A),[b,z]=n.useState(""),[T,L]=n.useState(0),C=n.useRef(null),D=he(),[G,Z]=n.useState(0),[B,W]=n.useState(D?.h*.52),[X,q]=n.useState(!1),[J,Q]=n.useState(!1),[E,$]=n.useState({open:!1,id:null}),[M,P]=n.useState({open:!1,id:null}),[O,H]=n.useState({open:!1,id:null}),U=()=>{$({open:!1,id:null}),o(1)},ee=()=>{P({open:!1,id:null})},te=()=>{H({open:!1,id:null})};n.useEffect(()=>{W(D.h*.52)},[D]),n.useEffect(()=>{const a=C.current;if(a){const t=new ResizeObserver(k=>{for(let ne of k)Z(ne.contentRect.height)});return t.observe(a),()=>t.disconnect()}},[C]);const ae=a=>{z(a?.$y.toString())};return n.useEffect(()=>{(async()=>{let a=await N.get("/api/method/mbw_dms.api.router.get_team_sale");m(se({data:a.result.map(t=>({title:t.name,value:t.name,...t})),keyValue:"value",parentField:"parent_sales_person"}))})()},[]),n.useEffect(()=>{(async()=>{let a=await N.get("/api/method/mbw_dms.api.router.get_sale_person",{params:{team_sale:c,key_search:S}}),{message:t}=a;h(t.map(k=>({value:k.employee_code,label:k.employee_name||k.employee_code})))})()},[c,S]),n.useEffect(()=>{(b===void 0||b==="")&&z(ke),(async()=>{const a=await N.get("/api/method/mbw_dms.api.report.kpi.kpi_report",{params:{page_size:p,page_number:f,month:w,year:b,sales_team:c,employee:j}});g(a?.result),L(a?.result?.totals)})()},[w,b,c,j,f,X]),e.jsx(e.Fragment,{children:e.jsxs(me,{header:e.jsx(le,{title:"Báo cáo KPI",buttons:[{icon:e.jsx(ce,{className:"text-xl"}),size:"18px",className:"flex mr-2 ",action:()=>{q(a=>!a)}},{disabled:J,label:"Xuất dữ liệu",type:"primary",icon:e.jsx(_e,{className:"text-xl"}),size:"18px",className:"flex items-center",action:re.bind(null,{url:"/api/method/mbw_dms.api.exports.export_excel.export_excel",params:{report_type:"Report KPI",data_filter:{month:w,year:b}},file_name:"Report KPI.xlsx"},Q)}]}),children:[e.jsxs("div",{className:"bg-white rounded-2xl pt-4 pb-7 border-[#DFE3E8] border-[0.2px] border-solid",children:[e.jsxs(oe,{className:"px-4 flex-auto",gutter:[8,8],children:[e.jsx(I,{span:4,children:e.jsx(K,{className:"!bg-[#F4F6F8]",defaultValue:A,options:pe,onChange:a=>{V(a),o(1)}})}),e.jsx(I,{span:4,children:e.jsx(xe,{className:"!bg-[#F4F6F8] w-full rounded-lg h-7",onChange:ae,placeholder:"Chọn năm",picker:"year",defaultValue:_().startOf("year")})}),e.jsx(I,{span:4,children:e.jsx(ie,{placeholder:"Tất cả nhóm bán hàng",allowClear:!0,showSearch:!0,treeData:r,onChange:a=>{u(a),o(1)},dropdownStyle:{maxHeight:400,overflow:"auto",minWidth:350}})}),e.jsx(I,{span:4,children:e.jsx(K,{filterOption:!1,notFoundContent:null,allowClear:!0,showSearch:!0,placeholder:"Tất cả nhân viên",onSearch:a=>{v(a)},options:s,onSelect:a=>{y(a),o(1)},onClear:()=>{y("")}})})]}),e.jsx("div",{ref:C,className:"pt-5",children:e.jsxs(F,{dataSource:l?.data?.map(a=>({key:a.name,...a})),bordered:!0,scroll:{x:"max-content",y:G<400?void 0:B},pagination:T&&T>p?{pageSize:p,showSizeChanger:!1,total:T,current:f,onChange(a){o(a)}}:!1,summary:()=>e.jsxs(i.Summary.Row,{children:[e.jsx(i.Summary.Cell,{index:0}),e.jsx(i.Summary.Cell,{index:1,children:"Tổng"}),e.jsx(i.Summary.Cell,{index:2}),e.jsx(i.Summary.Cell,{index:3}),e.jsx(i.Summary.Cell,{index:4,className:"text-center",children:l?.sum?.tong_kh_vt}),e.jsx(i.Summary.Cell,{index:5,className:"text-center underline text-[#1877F2]",children:l?.sum?.tong_th_vt}),e.jsx(i.Summary.Cell,{index:6}),e.jsx(i.Summary.Cell,{index:7}),e.jsx(i.Summary.Cell,{index:8,children:Intl.NumberFormat().format(l?.sum?.tong_kh_doanh_so)}),e.jsx(i.Summary.Cell,{index:9,children:Intl.NumberFormat().format(l?.sum?.tong_th_doanh_so)}),e.jsx(i.Summary.Cell,{index:10}),e.jsx(i.Summary.Cell,{index:11,children:Intl.NumberFormat().format(l?.sum?.tong_kh_doanh_thu)}),e.jsx(i.Summary.Cell,{index:12,children:Intl.NumberFormat().format(l?.sum?.tong_th_doanh_thu)})]}),children:[e.jsx(d,{title:"STT",dataIndex:"stt",fixed:"left",className:"!text-center",width:60,render:(a,t,k)=>k+1},"stt"),e.jsx(d,{title:"Mã Nhân viên",dataIndex:"nhan_vien_ban_hang",fixed:"left",render:(a,t)=>e.jsx(e.Fragment,{children:e.jsx("div",{className:"!min-w-[130px]",children:t.nhan_vien_ban_hang})})},"nhan_vien_ban_hang"),e.jsx(d,{title:"Nhân viên",dataIndex:"ten_nv",fixed:"left",render:(a,t)=>e.jsx(e.Fragment,{children:e.jsx("div",{className:"!min-w-[200px]",children:t.ten_nv})})},"ten_nv"),e.jsx(d,{title:"Nhóm bán hàng",dataIndex:"nhom_ban_hang",render:(a,t)=>e.jsx("div",{className:"!min-w-[120px]",children:t.nhom_ban_hang})},"nhom_ban_hang"),e.jsxs(R,{className:"!whitespace-normal !min-w-[210px] !text-center",title:"Số lượt viếng thăm",children:[e.jsx(d,{className:"!text-center",title:"KH",width:70,dataIndex:"kh_vt"},"kh_vt"),e.jsx(d,{className:"!text-center underline text-[#1877F2]",title:"TH",width:70,dataIndex:"th_vt",render:(a,t)=>t?.kpi_month?.length==0?e.jsx(e.Fragment,{children:"0"}):t?.kpi_month?e.jsx("div",{onClick:()=>{$({open:!0,id:{employee:t?.nhan_vien_ban_hang,name_employee:t?.ten_nv}})},children:Intl.NumberFormat().format(t?.kpi_month?.th_vt)}):e.jsx(e.Fragment,{children:"0"})},"th_vt"),e.jsx(d,{className:"!text-center",title:"TL",width:70,dataIndex:"tl_vt",render:(a,t)=>e.jsxs(e.Fragment,{children:[t.tl_vt,"%"]})},"tl_vt")]}),e.jsx(d,{title:"Tổng ngày công",dataIndex:"tong_ngay_cong",className:"!text-center",render:(a,t)=>t?.kpi_month?.length==0?e.jsx(e.Fragment,{children:"0"}):t?.kpi_month?e.jsx("div",{className:"!min-w-[100px]",children:Intl.NumberFormat().format(t?.kpi_month?.tong_ngay_cong)}):e.jsx(e.Fragment,{children:"0"})},"tong_ngay_cong"),e.jsxs(R,{className:"!whitespace-normal",title:"Doanh số (VNĐ)",width:210,children:[e.jsx(d,{className:"!text-center",title:"KH",dataIndex:"kh_doanh_so",render:(a,t)=>e.jsx(e.Fragment,{children:Intl.NumberFormat().format(t.kh_doanh_so)})},"kh_doanh_so"),e.jsx(d,{className:"!text-center underline text-[#1877F2]",title:"TH",width:70,dataIndex:"th_doanh_so",render:(a,t)=>t?.kpi_month?.length==0?e.jsx(e.Fragment,{children:"0"}):t?.kpi_month?e.jsx("div",{onClick:()=>{P({open:!0,id:{employee:t?.nhan_vien_ban_hang,name_employee:t?.ten_nv}})},children:Intl.NumberFormat().format(t?.kpi_month?.th_doanh_so)}):e.jsx(e.Fragment,{children:"0"})},"th_doanh_so"),e.jsx(d,{className:"!text-center",title:"TL",width:70,dataIndex:"tl_doanh_so",render:(a,t)=>e.jsxs(e.Fragment,{children:[t.tl_doanh_so,"%"]})},"tl_doanh_so")]}),e.jsxs(R,{className:"!whitespace-normal",title:"Doanh thu (VNĐ)",width:210,children:[e.jsx(d,{className:"!text-center",title:"KH",width:70,dataIndex:"kh_doanh_thu",render:(a,t)=>e.jsx(e.Fragment,{children:Intl.NumberFormat().format(t.kh_doanh_thu)})},"kh_doanh_thu"),e.jsx(d,{className:"!text-center underline text-[#1877F2]",title:"TH",width:70,dataIndex:"th_doanh_thu",render:(a,t)=>t?.kpi_month?.length==0?e.jsx(e.Fragment,{children:"0"}):t?.kpi_month?e.jsx("div",{onClick:()=>{H({open:!0,id:{employee:t?.nhan_vien_ban_hang,name_employee:t?.ten_nv}})},children:Intl.NumberFormat().format(t?.kpi_month?.th_doanh_thu)}):e.jsx(e.Fragment,{children:"0"})},"th_doanh_thu"),e.jsx(d,{className:"!text-center",title:"TL",width:70,dataIndex:"tl_doanh_thu",render:(a,t)=>e.jsxs(e.Fragment,{children:[t.tl_doanh_thu,"%"]})},"tl_doanh_thu")]})]})})]}),e.jsx(Y,{title:e.jsxs("div",{className:"font-semibold text-2xl leading-[22px] text-[#222222] px-4 pt-4",children:["Số lượt viếng thăm - ",E.id?.name_employee]}),open:E.open,onCancel:U,footer:!1,width:1120,children:e.jsx(fe,{employee:E.id?.employee,month:w,year:b})}),e.jsx(Y,{title:e.jsxs("div",{className:"font-semibold text-2xl leading-[22px] text-[#222222] px-4 pt-4",children:["Doanh số - ",M.id?.name_employee]}),open:M.open,onCancel:ee,footer:!1,width:1120,children:e.jsx(ye,{employee:M.id?.employee,month:w,year:b})}),e.jsx(Y,{title:e.jsxs("div",{className:"font-semibold text-2xl leading-[22px] text-[#222222] px-4 pt-4",children:["Doanh thu - ",O.id?.name_employee]}),open:O.open,onCancel:te,footer:!1,width:1120,children:e.jsx(be,{employee:O.id?.employee,month:w,year:b})})]})})}function Ee(){return e.jsxs(e.Fragment,{children:[e.jsx(de,{children:e.jsx("title",{children:" ReportKPI"})}),e.jsx(we,{})]})}export{Ee as default};
