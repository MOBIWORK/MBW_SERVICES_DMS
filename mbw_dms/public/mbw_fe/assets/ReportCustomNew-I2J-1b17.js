import{Y as s,a_ as Se,a1 as m,a6 as be,L as e,a7 as ke,bD as Ce,R as T,P as u,aa as we,a2 as p,a9 as Ne,N as y,Q as j,ab as Fe,bE as l,V as i,aZ as A,ad as De}from"./index-GdyFhzYk.js";import{D as ve}from"./index-5WkEUWfW.js";import{u as Te,C as Ye}from"./index-mLacgNFo.js";import{e as Ie,f as Ee}from"./data-u-VkVTNg.js";import{u as _}from"./useDebount-80xQY_iz.js";import{a as Me,b as Re}from"./index.esm-JcUX44Un.js";import{D as H}from"./index-mzEHo5RF.js";import{S as ze}from"./SyncOutlined-YH0KFw9h.js";import{V as Le}from"./VerticalAlignBottomOutlined-rpQmuwJp.js";const K=i().startOf("month"),$=i().endOf("month");let Oe=Date.parse(K.$d)/1e3,Ve=Date.parse($.$d)/1e3;const Ge=[{title:"STT",dataIndex:"stt",key:"stt",className:"!text-center",width:60,render:(r,a,h)=>e.jsx("div",{className:"text-center",children:h+1})},{title:"Mã nhân viên",dataIndex:"sales_person_id",key:"sales_person_id"},{title:"Tên nhân viên",dataIndex:"sales_person",key:"sales_person",width:200},{title:"Nhóm bán hàng",dataIndex:"sales_team",key:"sales_team",width:200,render:(r,a)=>e.jsx("div",{className:"whitespace-normal",children:a.sales_team})},{title:"Mã khách hàng",dataIndex:"customer_code",key:"customer_code",render:(r,a)=>e.jsx("div",{children:a.customer_code})},{title:"Tên khách hàng",dataIndex:"customer_name",key:"customer_name",render:(r,a)=>e.jsx("div",{children:a.customer_name})},{title:"Loại khách hàng",dataIndex:"customer_type",key:"customer_type",render:(r,a)=>e.jsx("div",{children:a.customer_type})},{title:"Nhóm khách hàng",dataIndex:"customer_group",key:"customer_group",width:170,render:(r,a)=>e.jsx("div",{className:"truncate hover:whitespace-normal",children:a.customer_group})},{title:"Người liên hệ",dataIndex:"contact",key:"contact",render:(r,a)=>e.jsx("div",{children:a.contact})},{title:"SDT",dataIndex:"phone",key:"phone",render:(r,a)=>e.jsx("div",{children:a.phone})},{title:"Mã số thuế",dataIndex:"tax_id",key:"tax_id",render:(r,a)=>e.jsx("div",{children:a.tax_id})},{title:"Khu vưc",dataIndex:"territory",key:"territory",render:(r,a)=>e.jsx("div",{children:a.territory})},{title:"Địa chỉ",dataIndex:"address",key:"address",render:(r,a)=>e.jsx("div",{className:"truncate hover:whitespace-normal",children:a.address})},{title:"Ngày thu thập",dataIndex:"creation",key:"creation",render:(r,a)=>e.jsx("div",{children:i(a.creation*1e3).format("DD/MM/YYYY")})},{title:"Nguồn",dataIndex:"f1",key:"f1",className:"!text-center",render:r=>e.jsx("div",{className:"!text-center",children:r||"-"})},{title:e.jsx("div",{className:"!text-right",children:"Số lần VT"}),dataIndex:"totals_checkin",key:"totals_checkin",render:(r,a)=>e.jsx("div",{className:"!text-right",children:a.totals_checkin})},{title:"VT đầu",dataIndex:"first_checkin",key:"first_checkin",render:r=>r?e.jsx("p",{children:i(r*1e3).format("DD/MM/YYYY")}):e.jsx(e.Fragment,{})},{title:"VT cuối",dataIndex:"last_checkin",key:"last_checkin",render:r=>r?e.jsx("p",{children:i(r*1e3).format("DD/MM/YYYY")}):e.jsx(e.Fragment,{})},{title:e.jsx("div",{className:"!text-right",children:"Số đơn hàng"}),dataIndex:"totals_so",key:"totals_so",render:(r,a)=>e.jsx("div",{className:"!text-right",children:a.totals_so})},{title:"Đơn hàng cuối",dataIndex:"last_sale_order",key:"last_sale_order",render:r=>r?e.jsx("p",{children:i(r*1e3).format("DD/MM/YYYY")}):e.jsx(e.Fragment,{})}];function Be(){const[r,a]=s.useState([]),[h,q]=s.useState(0),f=20,[Y,g]=s.useState(1),[S]=Se(),[b,I]=s.useState(""),[X,Z]=s.useState([]),[Pe,Q]=s.useState([]),[k,Ae]=s.useState(""),[W,He]=s.useState(""),[C,E]=s.useState("");let M=_(W,500);const[c,R]=s.useState(Oe),[d,z]=s.useState(Ve),[w,L]=s.useState(""),[J,U]=s.useState([]),[ee,te]=s.useState("");let O=_(ee,500);const[N,V]=s.useState(""),[se,re]=s.useState([]),[ae,ne]=s.useState("");let G=_(ae,500);const[F,B]=s.useState(),[le,oe]=s.useState([]),[x,ie]=s.useState(),[ce,de]=s.useState("");let P=_(ce);const D=s.useRef(null),v=Te(),[Ke,me]=s.useState(0),[$e,ue]=s.useState(v?.h*.52),[he,xe]=s.useState(!1);s.useEffect(()=>{ue(v.h*.52)},[v]),s.useEffect(()=>{const t=D.current;if(t){const n=new ResizeObserver(o=>{for(let ge of o)me(ge.contentRect.height)});return n.observe(t),()=>n.disconnect()}},[D]);const pe=t=>{if(t==null)R("");else if(d&&t&&t.isAfter(i.unix(d),"day"))A.error("Từ ngày phải nhỏ hơn hoặc bằng Đến ngày");else{let n=Date.parse(t.$d)/1e3;R(n)}},ye=t=>{if(t==null)z("");else if(c&&t&&t.isBefore(i.unix(c),"day"))A.error("Đến ngày phải lớn hơn hoặc bằng Từ ngày");else{let n=Date.parse(t.$d)/1e3;z(n)}},je=t=>d?t&&t.isAfter(i.unix(d),"day"):!1,_e=t=>c?t&&t.isBefore(i.unix(c),"day"):!1,fe=t=>{t.customergroup?L(t.customergroup):L(""),t.customertype?E(t.customertype):E(""),t.territory,V(t.territory),t.hasorder?B(t.hasorder):B(void 0),g(1)};return s.useEffect(()=>{(async()=>{let t=await m.get("/api/method/mbw_dms.api.router.get_team_sale");oe(be({data:t.result.map(n=>({title:n.name,value:n.name,...n})),keyValue:"value",parentField:"parent_sales_person"}))})()},[]),s.useEffect(()=>{(async()=>{let t=await m.get("/api/method/mbw_dms.api.router.get_sale_person",{params:{team_sale:x,key_search:P}}),{message:n}=t;Z(n.map(o=>({value:o.sale_name,label:o.sale_name||o.employee_name||o.employee_code})))})()},[x,P]),s.useEffect(()=>{(async()=>{let t=await m.get("/api/method/frappe.desk.search.search_link",{params:{txt:M,doctype:"Department",ignore_user_permissions:0,query:""}}),{message:n}=t;Q(n.map(o=>({value:o.value.trim(),label:o.value.trim()})))})()},[M]),s.useEffect(()=>{(async()=>{let t=await m.get("/api/method/frappe.desk.search.search_link",{params:{txt:O,doctype:"Customer Group",ignore_user_permissions:0,query:""}}),{message:n}=t;U(n.map(o=>({value:o.value.trim(),label:o.value.trim()})))})()},[O]),s.useEffect(()=>{(async()=>{let t=await m.get("/api/method/frappe.desk.search.search_link",{params:{txt:G,doctype:"Territory",ignore_user_permissions:0,query:""}}),{message:n}=t;re(n.map(o=>({value:o.value,label:o.value})))})()},[G]),s.useEffect(()=>{(async()=>{const t=await m.get("/api/method/mbw_dms.api.report.customer_report.customer_report",{params:{page_size:f,page_number:Y,customer_type:C,customer_group:w,territory:N,sales_person:b,sales_team:x,has_sales_order:F,department:k,from_date:c,to_date:d}});let{result:n}=t;a({...n,data:n.data?.map(o=>({...o,key:o.cus_id}))}),q(n?.totals_cus)})()},[Y,C,w,N,b,F,k,he,c,d,x]),e.jsx(e.Fragment,{children:e.jsx(Ye,{header:e.jsx(ke,{title:"Báo cáo khách hàng mới",buttons:[{icon:e.jsx(ze,{className:"text-xl"}),size:"18px",className:"flex mr-2 ",action:()=>{xe(t=>!t)}},{label:"Xuất dữ liệu",type:"primary",icon:e.jsx(Le,{className:"text-xl"}),size:"18px",className:"flex items-center",action:Ce.bind(null,{url:"/api/method/mbw_dms.api.exports.export_excel.export_excel",params:{report_type:"Report Customer",data_filter:{customer_type:C,customer_group:w,territory:N,sales_person:b,sales_team:x,has_sales_order:F,department:k,from_date:c,to_date:d}},file_name:"Report Customer.xlsx"})}]}),children:e.jsxs("div",{className:"bg-white rounded-2xl pt-4 pb-7 border-[#DFE3E8] border-[0.2px] border-solid",children:[e.jsxs(T,{gutter:[16,16],className:"justify-between items-end w-full",children:[e.jsx(u,{className:"ml-4",children:e.jsxs(T,{gutter:[8,8],children:[e.jsx(u,{span:5,children:e.jsx(H,{format:"DD-MM-YYYY",className:"!bg-[#F4F6F8] w-full rounded-lg h-7",placeholder:"Từ ngày",onChange:pe,defaultValue:K,disabledDate:je})}),e.jsx(u,{span:5,children:e.jsx(H,{format:"DD-MM-YYYY",className:"!bg-[#F4F6F8] w-full rounded-lg h-7",onChange:ye,placeholder:"Đến ngày",defaultValue:$,disabledDate:_e})}),e.jsx(u,{span:7,children:e.jsx(we,{placeholder:"Tất cả nhóm bán hàng",allowClear:!0,showSearch:!0,treeData:le,onChange:t=>{ie(t)},dropdownStyle:{maxHeight:400,overflow:"auto",minWidth:350}})}),e.jsx(u,{span:7,children:e.jsx(p,{filterOption:!1,notFoundContent:null,allowClear:!0,showSearch:!0,placeholder:"Tất cả nhân viên",onSearch:t=>{de(t)},options:X,onSelect:t=>{I(t),g(1)},onClear:()=>{I("")}})})]})}),e.jsx(u,{className:"!ml-4",children:e.jsx("div",{className:"flex flex-wrap items-center",children:e.jsxs("div",{className:"flex justify-center items-center mr-4",children:[e.jsx(Ne,{className:"!h-8",placement:"bottomRight",trigger:["click"],dropdownRender:()=>e.jsxs(ve,{title:"Bộ lọc",children:[e.jsx("div",{className:"",children:e.jsxs(y,{layout:"vertical",form:S,onFinish:fe,children:[e.jsx(y.Item,{name:"customertype",label:"Loại khách hàng",className:"w-[468px] border-none",children:e.jsx(p,{className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:Ie,allowClear:!0,showSearch:!0,placeholder:"Tất cả loại khách hàng"})}),e.jsx(y.Item,{name:"customergroup",label:"Nhóm khách hàng",className:"w-[468px] border-none",children:e.jsx(p,{className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:J,allowClear:!0,onSearch:t=>{te(t)},showSearch:!0,placeholder:"Tất cả nhóm khách hàng"})}),e.jsx(y.Item,{label:"Phát sinh đơn hàng",name:"hasorder",className:"w-[468px] border-none",children:e.jsx(p,{placeholder:"Tất cả",className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:Ee,allowClear:!0,showSearch:!0})}),e.jsx(y.Item,{name:"territory",label:"Khu vực",className:"w-[468px] border-none",children:e.jsx(p,{className:"!bg-[#F4F6F8] options:bg-[#F4F6F8]",options:se,allowClear:!0,onSearch:t=>{ne(t)},showSearch:!0,placeholder:"Tất cẩ khu vực"})})]})}),e.jsxs(T,{className:"justify-between pt-6 pb-4",children:[e.jsx("div",{}),e.jsxs("div",{children:[e.jsx(j,{className:"mr-3",onClick:t=>{t.preventDefault(),S.resetFields()},children:"Đặt lại"}),e.jsx(j,{type:"primary",onClick:()=>{S.submit()},children:"Áp dụng"})]})]})]}),children:e.jsx(j,{onClick:t=>t.preventDefault(),className:"flex items-center text-nowrap !text-[13px] !leading-[21px] !font-normal  border-r-[0.1px] rounded-r-none h-8",icon:e.jsx(Me,{style:{fontSize:"20px"}}),children:"Bộ lọc"})}),e.jsx(j,{className:"border-l-[0.1px] rounded-l-none !h-8",children:e.jsx(Re,{style:{fontSize:"20px"}})})]})})})]}),e.jsx("div",{ref:D,className:"pt-5",children:e.jsx(Fe,{dataSource:r?.data,bordered:!0,columns:Ge,scroll:{x:3e3,y:400},pagination:h&&h>f?{pageSize:f,showSizeChanger:!1,total:h,current:r.page_number,onChange(t){g(t)}}:!1,summary:()=>e.jsxs(l.Summary.Row,{children:[e.jsx(l.Summary.Cell,{index:0}),e.jsx(l.Summary.Cell,{index:1,children:"Tổng"}),e.jsx(l.Summary.Cell,{index:2}),e.jsx(l.Summary.Cell,{index:3}),e.jsx(l.Summary.Cell,{index:4}),e.jsx(l.Summary.Cell,{index:5}),e.jsx(l.Summary.Cell,{index:6}),e.jsx(l.Summary.Cell,{index:7}),e.jsx(l.Summary.Cell,{index:8}),e.jsx(l.Summary.Cell,{index:9}),e.jsx(l.Summary.Cell,{index:10}),e.jsx(l.Summary.Cell,{index:11}),e.jsx(l.Summary.Cell,{index:12}),e.jsx(l.Summary.Cell,{index:13}),e.jsx(l.Summary.Cell,{index:14}),e.jsx(l.Summary.Cell,{index:15,children:e.jsx("div",{className:"text-right",children:r?.sum?.sum_checkin})}),e.jsx(l.Summary.Cell,{index:16}),e.jsx(l.Summary.Cell,{index:17}),e.jsx(l.Summary.Cell,{index:18,children:e.jsx("div",{className:"text-right",children:r?.sum?.sum_so})}),e.jsx(l.Summary.Cell,{index:19})]})})})]})})})}function st(){return e.jsxs(e.Fragment,{children:[e.jsx(De,{children:e.jsx("title",{children:" ReportCustomNew"})}),e.jsx(Be,{})]})}export{st as default};
