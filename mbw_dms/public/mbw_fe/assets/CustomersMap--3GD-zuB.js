import{W as c,a0 as y,aS as h,L as n,bG as f}from"./index-NhPg_Q1h.js";import{H as D}from"./header-page-16C0JbTr.js";function E(){const[l,b]=c.useState(""),[a,C]=c.useState([]),[m,x]=c.useState([]),e=c.useRef(null),[p,k]=c.useState(!1),[g,v]=c.useState(!0),N=()=>{k(!p)},H=()=>{v(!g),L()},L=()=>{const r=g?"none":"visible";e.current.getStyle().layers.forEach(t=>{t.id.includes("customer")&&e.current.setLayoutProperty(t.id,"visibility",r)})};c.useEffect(()=>{S()},[]),c.useEffect(()=>{l!=null&&l!=""&&B()},[l]),c.useEffect(()=>{M()},[m]),c.useEffect(()=>{A()},[a]);const S=async()=>{let r=await y.get("/api/method/mbw_dms.api.vgm.map_customer.get_config_api");b(r.result)},w=async()=>{let r=await y.get("/api/method/mbw_dms.api.vgm.map_customer.get_config_map?type_industry=fertilizer_store");console.log(r),C(r.result)},T=async()=>{let r=JSON.parse('{"message":"Thành công","result":[{"name":"A Lâm","customer_name":"A Lâm","customer_code":"BH0123111115","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"A Lâm","customer_primary_address":"395 Xuân Đỉnh, phường Xuân Đỉnh, Từ Liêm, Hà Nội, Việt Nam-Billing","customer_location_primary":"{\\"lat\\":20.7894317,\\"long\\":105.70448}"},{"name":"A Phương","customer_name":"A Phương","customer_code":"BH0120235252","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"A Phương-A Phương","customer_primary_address":"538 Xuân Đỉnh, phường Xuân Đỉnh, Tây Hồ, Hà Nội, Việt Nam-Billing","customer_location_primary":"{\\"lat\\":21.0763504,\\"long\\":105.7869008}"},{"name":"A thuật","customer_name":"A thuật","customer_code":"HN11402","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":null,"customer_primary_address":"Đình Vĩnh Xương Trung, Mỹ Thành, Mỹ Đức, Hà Nội-Billing","customer_location_primary":"{\\"lat\\":20.6903959,\\"long\\":105.7689993}"},{"name":"A Toản","customer_name":"A Toản","customer_code":"BH0050608072022","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"A Toản","customer_primary_address":"408 Trần Cung, Cổ Nhuế 1, Cầu Giấy, Hà Nội, Việt Nam-Billing","customer_location_primary":"{\\"lat\\":21.0555955,\\"long\\":105.7855697}"},{"name":"Anh  Hạnh","customer_name":"Anh  Hạnh","customer_code":"BH0057110022023","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":"Anh  Hạnh","customer_primary_address":"440 Cổ Nhuế, Cổ Nhuế 2, Từ Liêm, Hà Nội, Vietnam-Billing","customer_location_primary":"{\\"lat\\":21.069679,\\"long\\":105.7781418}"},{"name":"Xuyến  ngũ","customer_name":"Xuyến  ngũ","customer_code":"HN9251","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":null,"customer_primary_address":"Huyện Ứng Hòa, Hà Nội, VNM-Billing-2","customer_location_primary":"{\\"lat\\":20.7192067,\\"long\\":105.8028217}"},{"name":"Yến  Hiệp","customer_name":"Yến  Hiệp","customer_code":"HN8847","customer_type":"Company","customer_group":"Khách lẻ","territory":"Thành phố Hà Nội","customer_primary_contact":null,"customer_primary_address":"Tảo Khê  tảo  Dương  văn  ứng  hòa hà Nội-Billing","customer_location_primary":"{\\"lat\\":20.7082736,\\"long\\":105.7821972}"}]}');console.log(r),x(r.result)},B=()=>{e.current=new h.Map({container:"map",center:[108.485,16.449],zoom:5.43}),new ekmapplf.VectorBaseMap("OSM:Bright",l).addTo(e.current);var r=new ekmapplf.control.BaseMap({id:"basemap_control",baseLayers:[{id:"OSM:Bright",title:"Bản đồ nền Sáng",thumbnail:"https://docs.ekgis.vn/assets/map-sang.png",width:"50px",height:"50px"},{id:"OSM:Standard",title:"Bản đồ nền Tiêu chuẩn",thumbnail:"https://docs.ekgis.vn/assets/map-chuan.png",width:"50px",height:"50px"},{id:"OSM:Night",title:"Bản đồ nền Đêm",thumbnail:"https://docs.ekgis.vn/assets/dem-map.png",width:"50px",height:"50px"}]});e.current.addControl(r,"bottom-left"),r.on("changeBaseLayer",async function(u){await new ekmapplf.VectorBaseMap(u.layer,l).addTo(e.current)}),e.current.addControl(new h.NavigationControl({visualizePitch:!0}),"bottom-right");var t=!1;e.current.getPitch()>0?t=!0:t=!1;var s="maplibregl-terrain2d-control",o="Hiển thị 2D";t||(s="maplibregl-terrain3d-control",o="Bản đồ 3D");let i=new ekmapplf.control.Button({className:"btn-ctl-group "+s,icon:"none",tooltip:o});i.on("click",u=>{t=!t,t?(u._div.className=u._div.className.replaceAll("maplibregl-terrain3d-control","maplibregl-terrain2d-control"),u._div.title="Hiển thị 2D"):(u._div.className=u._div.className.replaceAll("maplibregl-terrain2d-control","maplibregl-terrain3d-control"),u._div.title="Hiển thị 3D"),t?(e.current.easeTo({pitch:60}),e.current.setLayoutProperty("building-3d","visibility","visible")):(e.current.easeTo({pitch:0}),e.current.setLayoutProperty("building-3d","visibility","none"))}),e.current.addControl(i,"bottom-right"),e.current.addControl(new h.FullscreenControl,"top-right"),e.current.on("load",async()=>{await w(),T()})},A=()=>{for(let r=0;r<a.length;r++)if(a[r].visible){let t=a[r].sources,s=a[r].layers;for(let o in t)e.current.getSource(o)||e.current.addSource(o,t[o]);for(let o=0;o<s.length;o++)e.current.getLayer(s[o].id)||e.current.addLayer(s[o])}},M=async()=>{let r={type:"FeatureCollection",features:[]};for(let t=0;t<m.length;t++){let s=JSON.parse(m[t].customer_location_primary),o={type:"Feature",geometry:{type:"Point",coordinates:[s.long,s.lat]},properties:m[t]};r.features.push(o)}if(e.current!=null&&e.current.isStyleLoaded())if(e.current.getSource("customer_clus"))e.current.getSource("customer_clus").setData(r);else{if(!e.current.getImage("marker-customer")){const t=await e.current.loadImage("/public/check-icon.png");e.current.addImage("marker-customer",t.data)}e.current.addSource("customer_clus",{type:"geojson",data:r,cluster:!0,clusterRadius:12}),e.current.addLayer({id:"customer_clus-cluster",type:"circle",source:"customer_clus",maxzoom:16,filter:["has","point_count"],paint:{"circle-color":["step",["get","point_count"],"#90D667",10,"#EFCD41",50,"#FF0012"],"circle-radius":12,"circle-stroke-color":["step",["get","point_count"],"#90D667",10,"#EFCD41",50,"#FF0012"],"circle-stroke-opacity":.7,"circle-stroke-width":5}}),e.current.addLayer({id:"customer_clus-cluster-count",type:"symbol",source:"customer_clus",filter:["has","point_count"],layout:{"text-field":"{point_count}","text-size":12}}),e.current.on("mouseenter","customer_clus-uncluster",()=>{e.current.getCanvas().style.cursor="pointer"}),e.current.on("mouseleave","customer_clus-uncluster",()=>{e.current.getCanvas().style.cursor=""}),e.current.on("click","customer_clus-cluster",async t=>{const s=e.current.queryRenderedFeatures(t.point,{layers:["customer_clus-cluster"]}),o=s[0].properties.cluster_id,i=await e.current.getSource("customer_clus-cluster").getClusterExpansionZoom(o);e.current.easeTo({center:s[0].geometry.coordinates,zoom:i+.01})}),e.current.addLayer({id:"customer_clus-uncluster",type:"symbol",source:"customer_clus",filter:["!",["has","point_count"]],layout:{"icon-image":"marker-customer","icon-allow-overlap":!0,"icon-size":{stops:[[15,.7],[18,1]]}}}),e.current.addLayer({id:"customer_clus-title",type:"symbol",source:"customer_clus",filter:["!",["has","point_count"]],layout:{"text-field":["get","customer_name"],"text-font":["Roboto Medium"],"text-size":{stops:[[12,10],[13,11],[14,11],[15,11.5],[16,12.5],[20,16]]},"text-anchor":"top","text-max-width":9,"text-offset":[0,1.5],"text-padding":5},paint:{"text-color":"#ff5532","text-halo-color":"#ffffff","text-halo-width":1,"text-halo-blur":.5}}),e.current.on("click","customer_clus-uncluster",function(t){var s=t.features[0].geometry.coordinates.slice(),o=t.features[0].properties,i=`
                <div class="customer-popup-info">
                    <b>${o.customer_name}</b>
                </div>
            `;o.customer_primary_address!=null&&o.customer_primary_address!=""&&(i+=`
                <div class="customer-popup-info">
                    <span class="customer-popup-icon customer-icon-marker customer-icon-default-color"></span>
                    <span>${o.customer_primary_address}</span>
                </div>`),o.customer_primary_contact!=null&&o.customer_primary_contact!=""&&(i+=`
                <div class="customer-popup-info">
                    <span class="customer-popup-icon customer-icon-phone customer-icon-default-color"></span>
                    <span>${o.customer_primary_contact}</span>
                </div>`),new h.Popup().setLngLat(s).setHTML(i).addTo(e.current)})}},[d,_]=c.useState([]),j=r=>{const t=[...d];t[r]=!t[r],_(t)};return c.useEffect(()=>{_(a.map(r=>r.visible))},[a]),c.useEffect(()=>{console.log(d,"defaulCheckbox")},[d]),n.jsxs(n.Fragment,{children:[n.jsx(D,{title:"Bản đồ khách hàng"}),n.jsx("div",{id:"map",style:{width:"100%",height:"80vh",borderRadius:"20px"},children:n.jsxs("div",{id:"ekmapplf_tracking_legend",className:"ekmapplf_tracking-map-legend",children:[n.jsxs("div",{className:"ekmapplf_tracking-legend-title",onClick:N,children:[n.jsx("span",{className:`icon ${p?"ekmapplf_tracking-icon-square-minus":"ekmapplf_tracking-icon-square-plus"}`,style:{filter:"invert(100%) sepia(100%) saturate(0%) hue-rotate(187deg) brightness(105%) contrast(103%)"}}),n.jsx("span",{children:"Chú giải bản đồ"})]}),n.jsx("div",{className:`ekmapplf_tracking-legend-body ${p?"open":""}`,style:{maxHeight:p?"none":"0"},children:n.jsxs("ul",{children:[n.jsxs("li",{children:[n.jsx(f,{checked:g,onChange:H}),n.jsx("span",{className:"ekmapplf_tracking-legend-icon",style:{backgroundImage:"url('/checking.png')"}}),"Vị trí khách hàng"]}),a.map((r,t)=>{const s=r.label||`${a[0].label} - ${r.type}`;return n.jsxs("li",{children:[n.jsx(f,{checked:d[t],onChange:()=>j(t)}),s]},t)})]})})]})})]})}function V(){return n.jsx(E,{})}export{V as default};
